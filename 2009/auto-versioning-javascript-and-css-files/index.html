
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Auto-versioning JavaScript & CSS Files - Scribbles and Bits</title>
  <meta name="author" content="Derek Gathright">

  
  <meta name="description" content="As JavaScript becomes a more integral part to the core functionality of websites, ensuring that a user has a fresh copy of the latest code is as &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://derek.github.io/blog/2009/auto-versioning-javascript-and-css-files">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Scribbles and Bits" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">Scribbles and Bits</a></h1>
  
    <h2>by Derek Gathright</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:derek.github.io/blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Auto-versioning JavaScript & CSS Files</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-09-04T11:45:26-07:00" pubdate data-updated="true">Sep 4<span>th</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>As JavaScript becomes a more integral part to the core functionality of websites, ensuring that a user has a fresh copy of the latest code is as important as ever.  Normally a browser will cache certain filetypes (CSS, JS, JPG, etc&hellip;) for an indefinite period of time.  If the code within one of these cached files is updated, sometimes a browser will not know to reload that file.  So, if those changes are important for the functionality of your website, your users may run into issues and not be able to use your site properly.  Worse, they likely won&rsquo;t have any idea what the issue is and will eventually give up and go elsewhere. But have no fear, there&rsquo;s a solution to this problem&hellip; versioning your static files.</p>

<p>By &ldquo;versioning&rdquo; these files, I&rsquo;m referring to changing their filenames from &ldquo;my_styles.css&rdquo; to &ldquo;my_styles.version274.css&rdquo; for example.  The problem with that example is it relies on you renaming the file and updating your includes <strong>every time</strong> you make a change.  That sounds like an nightmare, right?  Luckily there&rsquo;s a neat tactic you can you to make it appear to the browser to be a new file, but it will actually be the same file and will require no effort on your part.  This variation of the versioning tactic is often referred to as &ldquo;Auto-versioning&rdquo;.  Here&rsquo;s an example&hellip;</p>

<p>First, we use the following rewrite rule in .htaccess:</p>

<pre lang="ini">
RewriteEngine on
RewriteCond %{REQUEST_FILENAME} !-s # Make the file doesn't actually exist
RewriteRule ^(.*)\.[\d]+\.(css|js)$ $1.$2 [L] # Strip out the version number
</pre>


<p>Now, we write the following PHP fuction:</p>

<pre lang="php">
/**
 *  Given a file, i.e. /css/base.css, replaces it with a string containing the
 *  file's mtime, i.e. /css/base.1221534296.css.
 *  
 *  @param $file  The file to be loaded.  Must be an absolute path (i.e.
 *                starting with slash).
 */
function auto_version($file)
{
  if(strpos($file, '/') !== 0 || !file_exists($_SERVER['DOCUMENT_ROOT'] . $file))
    return $file;

  $mtime = filemtime($_SERVER['DOCUMENT_ROOT'] . $file);
  return preg_replace('{\\.([^./]+)$}', ".$mtime.\$1", $file);
}
</pre>


<p>Now, wherever you include your CSS, change it from this:</p>

<pre lang="html">
<link rel="stylesheet" href="/blog/css/base.css" type="text/css" />
</pre>


<p>To this:</p>

<pre lang="html">
<link rel="stylesheet" href="<?=auto_version('/css/base.css')?>" type="text/css" />
</pre>


<p>And when rendered, will appear as:</p>

<pre lang="html">
<link rel="stylesheet" href="/blog/css/base.1251992914.css" type="text/css" />
</pre>




<p>How does this work?  Because that mod_rewrite rule above will strip out the timestamp, your server will deliver /css/base.css as the requested file.  But to the user&#8217;s browser, it will appear as a different file whenever it is updated.</p>




<p>Neat!</p>




<br />


<hr />


<br />




<p><strong>Note</strong>: Some strategies to fix this caching issue is to append a version # onto the end of the css or JavaScript file with a querystring, such as:</p>


<pre lang="html">
<link rel="stylesheet" href="/blog/css/base.css?version=1234" type="text/css" />
</pre>




<p>This method will actually prevent the file from being cached, period!  This is bad.  You want the benefits of caching.  You don&#8217;t want to make your users pull down 100k of JavaScript & CSS files on every page load.  More importantly, your servers could start to strain under the additional load.</p>




<p>Why is it not cached?  See <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html">Section 13 from the HTTP Specification</a>, in particular Section 13.9</p>




<blockquote>
<strong>13.9 Side Effects of GET and HEAD</strong>

Unless the origin server explicitly prohibits the caching of their responses, the application of GET and HEAD methods to any resources SHOULD NOT have side effects that would lead to erroneous behavior if these responses are taken from a cache. They MAY still have side effects, but a cache is not required to consider such side effects in its caching decisions. Caches are always expected to observe an origin server&#8217;s explicit restrictions on caching.

We note one exception to this rule: since some applications have traditionally used GETs and HEADs with query URLs (those containing a &#8220;?&#8221; in the rel_path part) to perform operations with significant side effects, caches MUST NOT treat responses to such URIs as fresh unless the server provides an explicit expiration time. This specifically means that responses from HTTP/1.0 servers for such URIs SHOULD NOT be taken from a cache. See section 9.1.1 for related information. 
</blockquote>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Derek</span></span>

      








  


<time datetime="2009-09-04T11:45:26-07:00" pubdate data-updated="true">Sep 4<span>th</span>, 2009</time>
      

<span class="categories">
  
    <a class='category' href='/blog/blog/categories/web-development/'>Web Development</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://derek.github.io/blog/2009/auto-versioning-javascript-and-css-files/" data-via="" data-counturl="http://derek.github.io/blog/2009/auto-versioning-javascript-and-css-files/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2009/crowdsourcing-music-videos/" title="Previous Post: Crowdsourcing Music Videos">&laquo; Crowdsourcing Music Videos</a>
      
      
        <a class="basic-alignment right" href="/blog/2009/cloud-enabled/" title="Next Post: Cloud Enabled">Cloud Enabled &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/yui-benchmark/">YUI Benchmark</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/on-leaving-yahoo/">Leaving Yahoo</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/creating-an-api-service-with-yql/">Creating an API Service With YQL</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/learning-javascript/">Learning JavaScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/the-best-career-advice-youll-ever-get/">The Best Career Advice You'll Ever Get</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/splitt/">Splitt</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/planting-seeds/">Planting Seeds</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/joining-yui/">Joining YUI</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/the-engineer/">The Engineer</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/google-translate/">Google Shutting Down the Translate API</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Derek Gathright -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
